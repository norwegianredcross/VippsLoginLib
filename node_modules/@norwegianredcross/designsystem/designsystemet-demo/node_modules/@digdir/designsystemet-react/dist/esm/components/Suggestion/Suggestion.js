'use client';
import { jsx } from 'react/jsx-runtime';
import { Slot } from '@radix-ui/react-slot';
import { getDatalistValue, syncDatalistState } from '@u-elements/u-datalist';
import cl from 'clsx/lite';
import { forwardRef, createContext, useState, useId, useRef, useCallback } from 'react';

const SuggestionContext = createContext({});
/**
 * A component that provides a suggestion list for an input field.
 *
 * @example
 * <Suggestion>
 *   <Suggestion.Input />
 *   <Suggestion.Clear />
 *   <Suggestion.List>
 *     <Suggestion.Empty>Tomt</Suggestion.Empty>
 *     <Suggestion.Option value='Option 1'>Option 1</Suggestion.Option>
 *     <Suggestion.Option value='Option 2'>Option 2</Suggestion.Option>
 *   </Suggestion.List>
 * </Suggestion>
 */
const Suggestion = forwardRef(function Suggestion({ className, filter = true, asChild, ...rest }, ref) {
    const Component = asChild ? Slot : 'div';
    const [listId, setListId] = useState(useId());
    const inputRef = useRef(null);
    const handleFilter = useCallback((input) => {
        const list = input?.list;
        // Let <datalist> handle filtering if filter is true
        if (filter === true || !list)
            return;
        console.log(list);
        // Handle custom filter
        if (filter !== false) {
            let index = 0;
            for (const option of list.getElementsByTagName('u-option')) {
                if (!option.hasAttribute('data-empty'))
                    option.disabled = !filter({
                        index: index++, // Increment index for each <option>
                        input,
                        optionElement: option,
                        text: option.text,
                        value: getDatalistValue(option),
                    });
            }
        }
        syncDatalistState(input); // Sync the datalist state if filter is custom or false
    }, [filter]);
    return (jsx(SuggestionContext.Provider, { value: { inputRef, listId, setListId, handleFilter }, children: jsx(Component, { className: cl('ds-suggestion', className), ref: ref, ...rest }) }));
});

export { Suggestion, SuggestionContext };
